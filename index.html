<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Batch Planner</title>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- dayjs + plugins (required by antd-vue) -->
  <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/customParseFormat.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/weekday.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/localeData.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/weekOfYear.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/weekYear.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/advancedFormat.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/quarterOfYear.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/relativeTime.js"></script>
  <!-- Ant Design Vue 4.x -->
  <script src="https://unpkg.com/ant-design-vue@4.2.6/dist/antd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/ant-design-vue@4.2.6/dist/reset.css">
  <style>
    [v-cloak] { display: none; }
    html, body { margin: 0; padding: 0; background: #0a0a0a; color: #e8e8e8; min-height: 100vh; }

    /* ── Gradient Title ───────────────────────────────────── */
    .gradient-title {
      background: linear-gradient(135deg, #4096ff 0%, #9254de 50%, #1677ff 100%);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      animation: shimmer 6s ease-in-out infinite;
    }
    @keyframes shimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* ── Top Bar Glass Effect ─────────────────────────────── */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      height: 56px;
      line-height: 56px;
      background: rgba(20, 20, 20, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    /* ── Main Content ─────────────────────────────────────── */
    .main-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px 24px 40px;
    }

    /* ── Task Input Area ──────────────────────────────────── */
    .task-input-area {
      background: rgba(20, 20, 20, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }

    /* ── Task Card ────────────────────────────────────────── */
    .task-card {
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 12px;
      border-radius: 10px !important;
    }
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(22, 119, 255, 0.12);
    }
    .task-card-body {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .task-card-left {
      flex-shrink: 0;
      display: flex;
      align-items: center;
    }
    .task-card-center {
      flex: 1;
      min-width: 0;
    }
    .task-card-right {
      flex-shrink: 0;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .task-title {
      font-size: 14px;
      font-weight: 600;
      color: #e8e8e8;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .task-meta {
      font-size: 12px;
      color: #8c8c8c;
      margin-top: 2px;
    }

    /* ── Scrollbar ────────────────────────────────────────── */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    /* ── Pulse animation ──────────────────────────────────── */
    .pulse-dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* ── Diff display ─────────────────────────────────────── */
    .diff-container {
      font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
      font-size: 12px;
      line-height: 1.6;
      overflow-x: auto;
      border-radius: 8px;
      background: #111;
      border: 1px solid #262626;
    }
    .diff-line {
      padding: 0 12px;
      white-space: pre;
      min-height: 20px;
    }
    .diff-line-add {
      background: rgba(46, 160, 67, 0.15);
      color: #7ee787;
    }
    .diff-line-del {
      background: rgba(248, 81, 73, 0.15);
      color: #ffa198;
    }
    .diff-line-hunk {
      background: rgba(56, 58, 194, 0.2);
      color: #a5b4fc;
      font-weight: 600;
    }
    .diff-line-normal {
      color: #8c8c8c;
    }
    .diff-stat-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 16px;
      background: rgba(20, 20, 20, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 13px;
    }

    /* ── Markdown rendered content ────────────────────────── */
    .md-content h1 { font-size: 18px; font-weight: 700; margin: 16px 0 8px; color: #e8e8e8; }
    .md-content h2 { font-size: 16px; font-weight: 600; margin: 16px 0 8px; color: #e8e8e8; border-bottom: 1px solid #262626; padding-bottom: 4px; }
    .md-content h3 { font-size: 14px; font-weight: 600; margin: 12px 0 6px; color: #d9d9d9; }
    .md-content p { margin: 6px 0; line-height: 1.6; font-size: 13px; }
    .md-content ul, .md-content ol { padding-left: 20px; margin: 6px 0; }
    .md-content li { font-size: 13px; line-height: 1.6; margin: 2px 0; }
    .md-content code { background: #1a1a1a; padding: 1px 5px; border-radius: 3px; font-size: 12px; color: #ff85c0; }
    .md-content pre { background: #1a1a1a; padding: 12px; border-radius: 6px; overflow-x: auto; }
    .md-content pre code { padding: 0; background: transparent; }
    .md-content strong { color: #fff; }

    /* ── Error display ────────────────────────────────────── */
    .error-output {
      font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-all;
      padding: 16px;
      background: #1a1a1a;
      border-radius: 8px;
      color: #ff7875;
      max-height: 400px;
      overflow: auto;
    }

    /* ── Empty state ──────────────────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #595959;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    /* ── Activity indicator on card ───────────────────────── */
    .activity-indicator {
      font-size: 11px;
      color: #8c8c8c;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .activity-indicator .dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #1677ff;
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body>
<div id="app" v-cloak>
  <a-config-provider :theme="themeConfig">

    <!-- ==================== TOP BAR ==================== -->
    <div class="top-bar">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span class="gradient-title" style="font-size: 20px;">Claude Batch Planner</span>
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <a-select
          v-model:value="selectedProjectId"
          style="min-width: 180px;"
          placeholder="All Projects"
          allow-clear
          @change="onProjectFilterChange"
        >
          <a-select-option value="">All Projects</a-select-option>
          <a-select-option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</a-select-option>
        </a-select>
        <a-button @click="settingsVisible = true" shape="circle">
          <template #icon><SettingOutlined></SettingOutlined></template>
        </a-button>
      </div>
    </div>

    <!-- ==================== MAIN CONTENT ==================== -->
    <div class="main-content">

      <!-- Task Input Area -->
      <div class="task-input-area">
        <div style="display: flex; gap: 12px; align-items: flex-start;">
          <a-input
            v-model:value="newTaskTitle"
            placeholder="Enter task description..."
            size="large"
            style="flex: 1;"
            @keyup.enter="createTask"
          />
          <a-select
            v-model:value="newTaskProjectId"
            placeholder="Workspace (all projects)"
            size="large"
            style="min-width: 200px;"
            allow-clear
          >
            <a-select-option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</a-select-option>
          </a-select>
          <a-button
            type="primary"
            size="large"
            @click="createTask"
            :disabled="!newTaskTitle.trim()"
            :loading="creating"
          >Create</a-button>
        </div>
      </div>

      <!-- Task List -->
      <div v-if="filteredTasks.length === 0" class="empty-state">
        <div class="empty-state-icon">
          <InboxOutlined></InboxOutlined>
        </div>
        <a-typography-text type="secondary" style="font-size: 14px;">No tasks yet. Create one above to get started.</a-typography-text>
      </div>

      <div v-for="task in filteredTasks" :key="task.id">
        <a-card class="task-card" size="small" :body-style="{ padding: '14px 18px' }">
          <div class="task-card-body">
            <!-- Status Icon -->
            <div class="task-card-left">
              <a-spin v-if="task.status === 'planning' || task.status === 'executing'" size="small"></a-spin>
              <EyeOutlined v-else-if="task.status === 'review'" style="font-size: 18px; color: #fa8c16;"></EyeOutlined>
              <CheckCircleOutlined v-else-if="task.status === 'done'" style="font-size: 18px; color: #52c41a;"></CheckCircleOutlined>
              <CloseCircleOutlined v-else-if="task.status === 'failed'" style="font-size: 18px; color: #ff4d4f;"></CloseCircleOutlined>
              <MinusCircleOutlined v-else-if="task.status === 'rejected'" style="font-size: 18px; color: #8c8c8c;"></MinusCircleOutlined>
              <ClockCircleOutlined v-else style="font-size: 18px; color: #8c8c8c;"></ClockCircleOutlined>
            </div>

            <!-- Title + Meta -->
            <div class="task-card-center">
              <div style="display: flex; align-items: center; gap: 8px;">
                <a-tag
                  :color="statusTagColor(task.status)"
                  :bordered="false"
                  style="font-size: 11px; text-transform: capitalize;"
                >{{ statusLabel(task.status) }}</a-tag>
                <p class="task-title">{{ task.title }}</p>
              </div>
              <div class="task-meta">
                {{ projectName(task.project_id) }} &middot; {{ relativeTime(task.created_at || task.updated_at) }}
              </div>
              <!-- Activity indicator for executing tasks -->
              <div v-if="task.status === 'executing' && taskActivities[task.id]" class="activity-indicator">
                <span class="dot"></span>
                <span>{{ taskActivities[task.id] }}</span>
              </div>
            </div>

            <!-- Actions -->
            <div class="task-card-right">
              <!-- Planning: Cancel only -->
              <a-button v-if="task.status === 'planning'" size="small" @click.stop="cancelTask(task.id)">Cancel</a-button>

              <!-- Review: View Plan, Approve, Reject -->
              <template v-if="task.status === 'review'">
                <a-button size="small" @click.stop="openPlanDrawer(task)">View Plan</a-button>
                <a-button size="small" type="primary" style="background: #52c41a; border-color: #52c41a;" @click.stop="approveTask(task.id)">Approve</a-button>
                <a-button size="small" danger @click.stop="rejectTask(task.id)">Reject</a-button>
              </template>

              <!-- Executing: Cancel -->
              <a-button v-if="task.status === 'executing'" size="small" @click.stop="cancelTask(task.id)">Cancel</a-button>

              <!-- Done: View Diff, Merge, Delete -->
              <template v-if="task.status === 'done'">
                <a-button size="small" @click.stop="openDiffDrawer(task)">View Diff</a-button>
                <a-button size="small" type="primary" @click.stop="mergeTask(task.id)">Merge</a-button>
                <a-button size="small" danger ghost @click.stop="confirmDeleteTask(task)">
                  <template #icon><DeleteOutlined></DeleteOutlined></template>
                </a-button>
              </template>

              <!-- Failed: View Error, Retry, Delete -->
              <template v-if="task.status === 'failed'">
                <a-button size="small" @click.stop="openErrorModal(task)">View Error</a-button>
                <a-button size="small" type="primary" @click.stop="replanTask(task.id)">Retry</a-button>
                <a-button size="small" danger ghost @click.stop="confirmDeleteTask(task)">
                  <template #icon><DeleteOutlined></DeleteOutlined></template>
                </a-button>
              </template>

              <!-- Rejected: Replan, Delete -->
              <template v-if="task.status === 'rejected'">
                <a-button size="small" type="primary" @click.stop="replanTask(task.id)">Replan</a-button>
                <a-button size="small" danger ghost @click.stop="confirmDeleteTask(task)">
                  <template #icon><DeleteOutlined></DeleteOutlined></template>
                </a-button>
              </template>
            </div>
          </div>
        </a-card>
      </div>
    </div>

    <!-- ==================== PLAN REVIEW DRAWER ==================== -->
    <a-drawer
      :open="planDrawerVisible"
      @close="planDrawerVisible = false"
      :width="640"
      placement="right"
      :destroy-on-close="true"
    >
      <template #title>
        <div>
          <span style="font-weight: 600;">{{ planDrawerTask?.title }}</span>
          <a-typography-text type="secondary" code style="margin-left: 8px; font-size: 11px;">#{{ planDrawerTask?.id }}</a-typography-text>
        </div>
      </template>

      <template v-if="planDrawerTask">
        <!-- Description -->
        <div v-if="planDrawerTask.description" style="margin-bottom: 20px;">
          <a-typography-title :level="5" style="margin-bottom: 8px;">Description</a-typography-title>
          <a-typography-paragraph type="secondary">{{ planDrawerTask.description }}</a-typography-paragraph>
        </div>

        <div v-if="planContent" class="md-content" v-html="renderMarkdown(planContent)" style="line-height: 1.7;"></div>
        <div v-else style="text-align: center; padding: 40px;">
          <a-typography-text type="secondary">No plan data available.</a-typography-text>
        </div>
      </template>

      <template #footer>
        <div style="display: flex; justify-content: flex-end; gap: 8px;">
          <a-button @click="planDrawerVisible = false; replanTask(planDrawerTask?.id)">Replan</a-button>
          <a-button danger @click="planDrawerVisible = false; rejectTask(planDrawerTask?.id)">Reject</a-button>
          <a-button type="primary" style="background: #52c41a; border-color: #52c41a;"
                    @click="planDrawerVisible = false; approveTask(planDrawerTask?.id)">Approve</a-button>
        </div>
      </template>
    </a-drawer>

    <!-- ==================== DIFF VIEW DRAWER ==================== -->
    <a-drawer
      :open="diffDrawerVisible"
      @close="diffDrawerVisible = false"
      :width="720"
      placement="right"
      :destroy-on-close="true"
    >
      <template #title>
        <span style="font-weight: 600;">Diff: {{ diffDrawerTask?.title }}</span>
      </template>

      <template v-if="diffDrawerTask">
        <!-- Loading state -->
        <div v-if="diffLoading" style="text-align: center; padding: 60px;">
          <a-spin size="large"></a-spin>
          <div style="margin-top: 16px;">
            <a-typography-text type="secondary">Loading diff...</a-typography-text>
          </div>
        </div>
        <div v-else>
          <!-- Stat bar -->
          <div v-if="diffData.diff_stat" class="diff-stat-bar">
            <span>
              <strong>{{ diffData.diff_stat.files_changed }}</strong>
              <a-typography-text type="secondary"> files changed</a-typography-text>
            </span>
            <span style="color: #52c41a;">+{{ diffData.diff_stat.total_insertions }}</span>
            <span style="color: #ff4d4f;">-{{ diffData.diff_stat.total_deletions }}</span>
          </div>

          <!-- File list from diff -->
          <div v-if="diffFiles.length" style="margin-bottom: 16px;">
            <div v-for="(f, i) in diffFiles" :key="i"
                 style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; font-size: 12px; font-family: 'SF Mono', monospace;">
              <span style="color: #52c41a; min-width: 40px; text-align: right;">+{{ f.additions }}</span>
              <span style="color: #ff4d4f; min-width: 40px; text-align: right;">-{{ f.deletions }}</span>
              <span style="color: #e8e8e8;">{{ f.path }}</span>
            </div>
          </div>

          <!-- Diff content -->
          <div v-if="diffData.diff_content" class="diff-container">
            <div v-if="diffTruncated" style="padding: 8px 12px; color: #fa8c16; font-size: 12px; border-bottom: 1px solid #262626;">
              Diff truncated. {{ diffTotalLines }} lines total.
            </div>
            <div v-for="(line, i) in diffLines" :key="i"
                 :class="diffLineClass(line)"
                 class="diff-line">{{ line }}</div>
          </div>

          <div v-if="!diffData.diff_content && !diffData.diff_stat" style="text-align: center; padding: 40px;">
            <a-typography-text type="secondary">No diff data available.</a-typography-text>
          </div>
        </div>
      </template>

      <template #footer>
        <div style="display: flex; justify-content: flex-end; gap: 8px;">
          <a-button @click="diffDrawerVisible = false">Close</a-button>
          <a-button type="primary" @click="diffDrawerVisible = false; mergeTask(diffDrawerTask?.id)">Merge to main</a-button>
        </div>
      </template>
    </a-drawer>

    <!-- ==================== ERROR MODAL ==================== -->
    <a-modal
      v-model:open="errorModalVisible"
      :title="'Error: ' + (errorModalTask?.title || '')"
      :footer="null"
      :width="600"
    >
      <div v-if="errorModalTask" style="padding: 8px 0;">
        <div class="error-output">{{ errorModalTask.error || 'Unknown error occurred.' }}</div>
        <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px;">
          <a-button danger ghost @click="errorModalVisible = false; confirmDeleteTask(errorModalTask)">Delete</a-button>
          <a-button type="primary" @click="errorModalVisible = false; replanTask(errorModalTask.id)">Retry</a-button>
          <a-button @click="errorModalVisible = false">Close</a-button>
        </div>
      </div>
    </a-modal>

    <!-- ==================== SETTINGS MODAL ==================== -->
    <a-modal
      v-model:open="settingsVisible"
      title="Settings"
      @ok="saveSettings"
      ok-text="Save"
      cancel-text="Close"
      :confirm-loading="savingSettings"
    >
      <div style="padding: 8px 0;">
        <div style="margin-bottom: 16px;">
          <a-typography-text type="secondary" style="font-size: 12px; margin-bottom: 8px; display: block;">
            Scan Paths (one path per line)
          </a-typography-text>
          <a-textarea
            v-model:value="settingsData.scan_paths"
            :rows="4"
            placeholder="/path/to/projects&#10;/another/path"
          />
        </div>
        <div style="margin-bottom: 16px;">
          <a-typography-text type="secondary" style="font-size: 12px; margin-bottom: 8px; display: block;">
            Max Parallel Tasks
          </a-typography-text>
          <a-input-number
            v-model:value="settingsData.max_parallel_tasks"
            :min="1"
            :max="10"
            style="width: 120px;"
          />
        </div>
        <a-button @click="scanProjects" :loading="scanning" block>
          <template #icon><ScanOutlined></ScanOutlined></template>
          Scan Projects
        </a-button>
      </div>
    </a-modal>

    <!-- ==================== DELETE CONFIRMATION MODAL ==================== -->
    <a-modal
      v-model:open="deleteModalVisible"
      title="Delete Task"
      @ok="doDeleteTask"
      ok-text="Delete"
      :ok-button-props="{ danger: true }"
      cancel-text="Cancel"
    >
      <p>Delete task "{{ deleteModalTask?.title }}"?</p>
      <p style="color: #8c8c8c; font-size: 13px;">This will remove the worktree and branch.</p>
    </a-modal>

  </a-config-provider>
</div>

<script>
const { createApp, ref, computed, watch, onMounted, onUnmounted, nextTick } = Vue;

// dayjs plugins
dayjs.extend(dayjs_plugin_customParseFormat);
dayjs.extend(dayjs_plugin_weekday);
dayjs.extend(dayjs_plugin_localeData);
dayjs.extend(dayjs_plugin_weekOfYear);
dayjs.extend(dayjs_plugin_weekYear);
dayjs.extend(dayjs_plugin_advancedFormat);
dayjs.extend(dayjs_plugin_quarterOfYear);
dayjs.extend(dayjs_plugin_relativeTime);

const app = createApp({
  setup() {
    // ── Core State ──────────────────────────────────────────────────
    const projects = ref([]);
    const tasks = ref([]);
    const selectedProjectId = ref('');
    const newTaskTitle = ref('');
    const newTaskProjectId = ref('');
    const creating = ref(false);

    // Task activities (live indicators)
    const taskActivities = ref({});

    // Plan Drawer
    const planDrawerVisible = ref(false);
    const planDrawerTask = ref(null);

    // Diff Drawer
    const diffDrawerVisible = ref(false);
    const diffDrawerTask = ref(null);
    const diffData = ref({ diff_stat: null, diff_content: '' });
    const diffLoading = ref(false);

    // Settings Modal
    const settingsVisible = ref(false);
    const settingsData = ref({ scan_paths: '', max_parallel_tasks: 3 });
    const savingSettings = ref(false);
    const scanning = ref(false);

    // Error Modal
    const errorModalVisible = ref(false);
    const errorModalTask = ref(null);

    // Delete Modal
    const deleteModalVisible = ref(false);
    const deleteModalTask = ref(null);

    // ── Theme ───────────────────────────────────────────────────────
    const themeConfig = ref({
      algorithm: antd.theme.darkAlgorithm,
      token: {
        colorPrimary: '#4096ff',
        borderRadius: 8,
        colorBgContainer: '#141414',
        colorBgElevated: '#1a1a1a',
        colorBgLayout: '#0a0a0a',
        colorBorder: '#262626',
        colorBorderSecondary: '#1f1f1f',
        colorText: '#e8e8e8',
        colorTextSecondary: '#8c8c8c',
      },
    });

    // ── Computed ─────────────────────────────────────────────────────
    const filteredTasks = computed(() => {
      let list = tasks.value;
      if (selectedProjectId.value) {
        list = list.filter(t => t.project_id === selectedProjectId.value);
      }
      // Sort: active statuses first (planning, review, executing), then done/failed/rejected; within group by updated_at desc
      const statusOrder = { executing: 0, review: 1, planning: 2, rejected: 3, failed: 4, done: 5 };
      return [...list].sort((a, b) => {
        const oa = statusOrder[a.status] ?? 9;
        const ob = statusOrder[b.status] ?? 9;
        if (oa !== ob) return oa - ob;
        // Same status group: newest first
        const ta = a.updated_at || a.created_at || '';
        const tb = b.updated_at || b.created_at || '';
        return tb.localeCompare(ta);
      });
    });

    const planContent = computed(() => {
      if (!planDrawerTask.value?.plan) return null;
      // Plan is now stored as plain markdown text
      return planDrawerTask.value.plan;
    });

    const diffLines = computed(() => {
      if (!diffData.value.diff_content) return [];
      const allLines = diffData.value.diff_content.split('\n');
      if (allLines.length > 10000) {
        return allLines.slice(0, 10000);
      }
      return allLines;
    });

    const diffTruncated = computed(() => {
      if (!diffData.value.diff_content) return false;
      return diffData.value.diff_content.split('\n').length > 10000;
    });

    const diffTotalLines = computed(() => {
      if (!diffData.value.diff_content) return 0;
      return diffData.value.diff_content.split('\n').length;
    });

    const diffFiles = computed(() => {
      if (!diffData.value.diff_content) return [];
      const files = [];
      const lines = diffData.value.diff_content.split('\n');
      let currentFile = null;
      for (const line of lines) {
        // Match diff header: diff --git a/path b/path
        const diffMatch = line.match(/^diff --git a\/(.+) b\/(.+)/);
        if (diffMatch) {
          if (currentFile) files.push(currentFile);
          currentFile = { path: diffMatch[2], additions: 0, deletions: 0 };
          continue;
        }
        if (currentFile) {
          if (line.startsWith('+') && !line.startsWith('+++')) {
            currentFile.additions++;
          } else if (line.startsWith('-') && !line.startsWith('---')) {
            currentFile.deletions++;
          }
        }
      }
      if (currentFile) files.push(currentFile);
      return files;
    });

    // ── API Helper ──────────────────────────────────────────────────
    const api = async (path, opts) => {
      const res = await fetch(path, opts);
      return res.json();
    };

    // ── Markdown Renderer ───────────────────────────────────────────
    const renderMarkdown = (md) => {
      if (!md) return '';
      let html = md
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
        .replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>')
        .replace(/^(?!<[huplo])((?!<).+)$/gm, '<p>$1</p>')
        .replace(/\n{2,}/g, '\n');
      return html;
    };

    // ── Relative Time ───────────────────────────────────────────────
    const relativeTime = (dateStr) => {
      if (!dateStr) return '';
      const d = dayjs(dateStr.endsWith('Z') ? dateStr : dateStr + 'Z');
      if (!d.isValid()) return '';
      const now = dayjs();
      const diffSec = now.diff(d, 'second');
      if (diffSec < 10) return 'just now';
      if (diffSec < 60) return diffSec + 's ago';
      const diffMin = now.diff(d, 'minute');
      if (diffMin < 60) return diffMin + 'm ago';
      const diffHour = now.diff(d, 'hour');
      if (diffHour < 24) return diffHour + 'h ago';
      if (diffHour < 48) return 'yesterday';
      return d.format('MMM D');
    };

    // ── Status Helpers ──────────────────────────────────────────────
    const statusTagColor = (status) => ({
      planning: 'processing',
      review: 'orange',
      executing: 'processing',
      done: 'success',
      failed: 'error',
      rejected: 'default',
    }[status] || 'default');

    const statusLabel = (status) => ({
      planning: 'Planning',
      review: 'Review',
      executing: 'Executing',
      done: 'Done',
      failed: 'Failed',
      rejected: 'Rejected',
    }[status] || status);

    const projectName = (projectId) => {
      if (!projectId) return 'Workspace';
      const p = projects.value.find(x => x.id === projectId);
      return p ? p.name : projectId;
    };

    const diffLineClass = (line) => {
      if (line.startsWith('@@')) return 'diff-line-hunk';
      if (line.startsWith('+')) return 'diff-line-add';
      if (line.startsWith('-')) return 'diff-line-del';
      return 'diff-line-normal';
    };

    // ── Data Loading ────────────────────────────────────────────────
    const loadProjects = async () => {
      try {
        const data = await api('/api/v2/projects');
        if (Array.isArray(data)) {
          projects.value = data;
          // Auto-select if only one project
          if (data.length === 1 && !newTaskProjectId.value) {
            newTaskProjectId.value = data[0].id;
          }
        }
      } catch (e) {
        console.error('Failed to load projects:', e);
      }
    };

    const loadTasks = async () => {
      try {
        let url = '/api/v2/tasks';
        const params = [];
        if (selectedProjectId.value) {
          params.push('project_id=' + encodeURIComponent(selectedProjectId.value));
        }
        if (params.length) url += '?' + params.join('&');
        const data = await api(url);
        if (Array.isArray(data)) {
          tasks.value = data;
          // Update open drawer tasks
          if (planDrawerTask.value) {
            const updated = data.find(t => t.id === planDrawerTask.value.id);
            if (updated) planDrawerTask.value = updated;
          }
          if (diffDrawerTask.value) {
            const updated = data.find(t => t.id === diffDrawerTask.value.id);
            if (updated) diffDrawerTask.value = updated;
          }
          if (errorModalTask.value) {
            const updated = data.find(t => t.id === errorModalTask.value.id);
            if (updated) errorModalTask.value = updated;
          }
        }
      } catch (e) {
        console.error('Failed to load tasks:', e);
      }
    };

    const loadSettings = async () => {
      try {
        const data = await api('/api/v2/settings');
        if (data) {
          let paths = '';
          try {
            const arr = JSON.parse(data.scan_paths || '[]');
            paths = Array.isArray(arr) ? arr.join('\n') : data.scan_paths;
          } catch { paths = data.scan_paths || ''; }
          settingsData.value = {
            scan_paths: paths,
            max_parallel_tasks: parseInt(data.max_parallel_tasks) || 3,
          };
        }
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
    };

    // ── Task Actions ────────────────────────────────────────────────
    const createTask = async () => {
      if (!newTaskTitle.value.trim()) return;
      creating.value = true;
      try {
        const body = { title: newTaskTitle.value.trim() };
        if (newTaskProjectId.value) body.project_id = newTaskProjectId.value;
        const res = await api('/api/v2/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        if (res && res.id) {
          newTaskTitle.value = '';
          // Only add if not already present (WebSocket may have added it first)
          if (!tasks.value.find(t => t.id === res.id)) {
            tasks.value.unshift(res);
          }
          antd.message.success('Task created');
        } else if (res?.error) {
          antd.message.error(res.error);
        }
      } catch (e) {
        antd.message.error('Failed to create task: ' + e.message);
      } finally {
        creating.value = false;
      }
    };

    const approveTask = async (id) => {
      if (!id) return;
      try {
        const res = await api(`/api/v2/tasks/${id}/approve`, { method: 'POST' });
        if (res?.ok) {
          antd.message.success('Task approved');
          await loadTasks();
        } else {
          antd.message.error(res?.error || 'Failed to approve task');
        }
      } catch (e) {
        antd.message.error('Failed to approve task: ' + e.message);
      }
    };

    const rejectTask = async (id) => {
      if (!id) return;
      try {
        const res = await api(`/api/v2/tasks/${id}/reject`, { method: 'POST' });
        if (res?.ok) {
          antd.message.info('Task rejected');
          await loadTasks();
        } else {
          antd.message.error(res?.error || 'Failed to reject task');
        }
      } catch (e) {
        antd.message.error('Failed to reject task: ' + e.message);
      }
    };

    const replanTask = async (id) => {
      if (!id) return;
      try {
        const res = await api(`/api/v2/tasks/${id}/replan`, { method: 'POST' });
        if (res?.ok) {
          antd.message.info('Replanning task...');
          await loadTasks();
        } else {
          antd.message.error(res?.error || 'Failed to replan task');
        }
      } catch (e) {
        antd.message.error('Failed to replan task: ' + e.message);
      }
    };

    const cancelTask = async (id) => {
      if (!id) return;
      try {
        const res = await api(`/api/v2/tasks/${id}/cancel`, { method: 'POST' });
        if (res?.ok) {
          antd.message.info('Task cancelled');
          await loadTasks();
        } else {
          antd.message.error(res?.error || 'Failed to cancel task');
        }
      } catch (e) {
        antd.message.error('Failed to cancel task: ' + e.message);
      }
    };

    const deleteTask = async (id) => {
      if (!id) return;
      try {
        const res = await api(`/api/v2/tasks/${id}`, { method: 'DELETE' });
        if (res?.ok) {
          tasks.value = tasks.value.filter(t => t.id !== id);
          antd.message.success('Task deleted');
        } else {
          antd.message.error(res?.error || 'Failed to delete task');
        }
      } catch (e) {
        antd.message.error('Failed to delete task: ' + e.message);
      }
    };

    const mergeTask = async (id) => {
      if (!id) return;
      try {
        const res = await api(`/api/v2/tasks/${id}/merge`, { method: 'POST' });
        if (res?.ok) {
          antd.message.success('Task merged to main');
          await loadTasks();
        } else {
          antd.message.error(res?.error || 'Failed to merge task');
        }
      } catch (e) {
        antd.message.error('Failed to merge task: ' + e.message);
      }
    };

    const loadDiff = async (id) => {
      diffLoading.value = true;
      diffData.value = { diff_stat: null, diff_content: '' };
      try {
        const data = await api(`/api/v2/tasks/${id}/diff`);
        diffData.value = {
          diff_stat: data.diff_stat || null,
          diff_content: data.diff_content || '',
        };
      } catch (e) {
        antd.message.error('Failed to load diff: ' + e.message);
      } finally {
        diffLoading.value = false;
      }
    };

    // ── Drawer / Modal Openers ──────────────────────────────────────
    const openPlanDrawer = (task) => {
      planDrawerTask.value = task;
      planDrawerVisible.value = true;
    };

    const openDiffDrawer = (task) => {
      diffDrawerTask.value = task;
      diffDrawerVisible.value = true;
      loadDiff(task.id);
    };

    const openErrorModal = (task) => {
      errorModalTask.value = task;
      errorModalVisible.value = true;
    };

    const confirmDeleteTask = (task) => {
      deleteModalTask.value = task;
      deleteModalVisible.value = true;
    };

    const doDeleteTask = async () => {
      if (deleteModalTask.value) {
        await deleteTask(deleteModalTask.value.id);
      }
      deleteModalVisible.value = false;
      deleteModalTask.value = null;
    };

    // ── Settings ────────────────────────────────────────────────────
    const saveSettings = async () => {
      savingSettings.value = true;
      try {
        const res = await api('/api/v2/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            settings: {
              scan_paths: JSON.stringify(settingsData.value.scan_paths.split('\n').map(s => s.trim()).filter(Boolean)),
              max_parallel_tasks: String(settingsData.value.max_parallel_tasks),
            }
          }),
        });
        if (res?.ok !== false) {
          antd.message.success('Settings saved');
          settingsVisible.value = false;
        } else {
          antd.message.error(res?.error || 'Failed to save settings');
        }
      } catch (e) {
        antd.message.error('Failed to save settings: ' + e.message);
      } finally {
        savingSettings.value = false;
      }
    };

    const scanProjects = async () => {
      scanning.value = true;
      try {
        const res = await api('/api/v2/projects/scan', { method: 'POST' });
        if (res?.ok) {
          antd.message.success('Projects scanned: ' + (res.projects?.length || 0) + ' found');
          await loadProjects();
        } else {
          antd.message.error(res?.error || 'Failed to scan projects');
        }
      } catch (e) {
        antd.message.error('Failed to scan projects: ' + e.message);
      } finally {
        scanning.value = false;
      }
    };

    const onProjectFilterChange = () => {
      loadTasks();
    };

    // ── WebSocket ───────────────────────────────────────────────────
    let ws = null;
    let wsRetryTimer = null;

    const connectWs = () => {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${proto}//${location.host}/ws`);

      ws.onopen = () => {
        console.log('WebSocket connected');
      };

      ws.onclose = () => {
        console.log('WebSocket disconnected, retrying in 3s...');
        wsRetryTimer = setTimeout(connectWs, 3000);
      };

      ws.onerror = () => {};

      ws.onmessage = async (e) => {
        try {
          const msg = JSON.parse(e.data);
          handleWsEvent(msg);
        } catch (err) {
          console.error('WS parse error:', err);
        }
      };
    };

    const handleWsEvent = async (msg) => {
      switch (msg.type) {
        case 'task_created': {
          // Add or update the task in local list
          const existing = tasks.value.findIndex(t => t.id === msg.task?.id);
          if (existing >= 0) {
            tasks.value[existing] = msg.task;
          } else if (msg.task) {
            tasks.value.unshift(msg.task);
          }
          break;
        }

        case 'task_planning': {
          updateTaskStatus(msg.task_id, 'planning');
          break;
        }

        case 'task_plan_ready': {
          const idx = tasks.value.findIndex(t => t.id === msg.task_id);
          if (idx >= 0) {
            tasks.value[idx] = { ...tasks.value[idx], status: 'review', plan: msg.plan };
          }
          antd.message.info('Plan ready for review: ' + (tasks.value.find(t => t.id === msg.task_id)?.title || msg.task_id));
          break;
        }

        case 'task_approved': {
          updateTaskStatus(msg.task_id, 'executing');
          break;
        }

        case 'task_executing': {
          updateTaskStatus(msg.task_id, 'executing');
          break;
        }

        case 'task_activity': {
          // Store latest activity for the task
          if (msg.task_id && msg.summary) {
            taskActivities.value = {
              ...taskActivities.value,
              [msg.task_id]: (msg.tool ? '[' + msg.tool + '] ' : '') + msg.summary
            };
          }
          break;
        }

        case 'task_done': {
          updateTaskStatus(msg.task_id, 'done');
          // Clear activity
          delete taskActivities.value[msg.task_id];
          antd.message.success('Task completed: ' + (tasks.value.find(t => t.id === msg.task_id)?.title || msg.task_id));
          break;
        }

        case 'task_failed': {
          const idx = tasks.value.findIndex(t => t.id === msg.task_id);
          if (idx >= 0) {
            tasks.value[idx] = { ...tasks.value[idx], status: 'failed', error: msg.error };
          }
          // Clear activity
          delete taskActivities.value[msg.task_id];
          antd.message.error('Task failed: ' + (tasks.value.find(t => t.id === msg.task_id)?.title || msg.task_id));
          break;
        }

        case 'task_merged': {
          updateTaskStatus(msg.task_id, 'merged');
          antd.message.success('Task merged: ' + (tasks.value.find(t => t.id === msg.task_id)?.title || msg.task_id));
          await loadTasks();
          break;
        }

        default:
          break;
      }
    };

    const updateTaskStatus = (taskId, status) => {
      const idx = tasks.value.findIndex(t => t.id === taskId);
      if (idx >= 0) {
        tasks.value[idx] = { ...tasks.value[idx], status };
      }
    };

    // ── Polling Fallback ────────────────────────────────────────────
    let pollTimer = null;
    const startPolling = () => {
      pollTimer = setInterval(async () => {
        await loadTasks();
      }, 5000);
    };

    // ── Lifecycle ───────────────────────────────────────────────────
    onMounted(async () => {
      await Promise.all([loadProjects(), loadTasks(), loadSettings()]);
      connectWs();
      startPolling();
    });

    onUnmounted(() => {
      if (ws) ws.close();
      if (wsRetryTimer) clearTimeout(wsRetryTimer);
      if (pollTimer) clearInterval(pollTimer);
    });

    return {
      // State
      projects, tasks, selectedProjectId,
      newTaskTitle, newTaskProjectId, creating,
      taskActivities,
      planDrawerVisible, planDrawerTask,
      diffDrawerVisible, diffDrawerTask, diffData, diffLoading,
      settingsVisible, settingsData, savingSettings, scanning,
      errorModalVisible, errorModalTask,
      deleteModalVisible, deleteModalTask,
      themeConfig,

      // Computed
      filteredTasks, planContent,
      diffLines, diffTruncated, diffTotalLines, diffFiles,

      // Methods
      createTask, approveTask, rejectTask, replanTask, cancelTask,
      mergeTask, loadDiff,
      openPlanDrawer, openDiffDrawer, openErrorModal,
      confirmDeleteTask, doDeleteTask,
      saveSettings, scanProjects,
      onProjectFilterChange,
      relativeTime, statusTagColor, statusLabel, projectName,
      diffLineClass, renderMarkdown,
    };
  }
});

// Register icon components
app.component('SettingOutlined', antd.SettingOutlined || {
  template: `<span role="img" aria-label="setting" style="font-size: inherit;">&#9881;</span>`
});
app.component('EyeOutlined', antd.EyeOutlined || {
  template: `<span role="img" aria-label="eye" style="font-size: inherit;">&#128065;</span>`
});
app.component('CheckCircleOutlined', antd.CheckCircleOutlined || {
  template: `<span role="img" aria-label="check" style="font-size: inherit; color: inherit;">&#10004;</span>`
});
app.component('CloseCircleOutlined', antd.CloseCircleOutlined || {
  template: `<span role="img" aria-label="close" style="font-size: inherit; color: inherit;">&#10006;</span>`
});
app.component('MinusCircleOutlined', antd.MinusCircleOutlined || {
  template: `<span role="img" aria-label="minus" style="font-size: inherit; color: inherit;">&#8854;</span>`
});
app.component('ClockCircleOutlined', antd.ClockCircleOutlined || {
  template: `<span role="img" aria-label="clock" style="font-size: inherit; color: inherit;">&#128339;</span>`
});
app.component('DeleteOutlined', antd.DeleteOutlined || {
  template: `<span role="img" aria-label="delete" style="font-size: inherit;">&#128465;</span>`
});
app.component('InboxOutlined', antd.InboxOutlined || {
  template: `<span role="img" aria-label="inbox" style="font-size: inherit;">&#128230;</span>`
});
app.component('ScanOutlined', antd.ScanOutlined || {
  template: `<span role="img" aria-label="scan" style="font-size: inherit;">&#128269;</span>`
});

app.use(antd);
app.mount('#app');
</script>
</body>
</html>
