<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Autopilot Dashboard</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <style>
    [v-cloak] { display: none; }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
    .slide-enter-from, .slide-leave-to { transform: translateX(100%); }
    .kanban-col { min-height: calc(100vh - 200px); }
    .task-card { transition: all 0.2s ease; }
    .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .markdown-body h1 { font-size: 1.5em; font-weight: bold; margin: 0.5em 0; }
    .markdown-body h2 { font-size: 1.25em; font-weight: bold; margin: 0.5em 0; }
    .markdown-body h3 { font-size: 1.1em; font-weight: bold; margin: 0.5em 0; }
    .markdown-body ul { list-style: disc; padding-left: 1.5em; }
    .markdown-body ol { list-style: decimal; padding-left: 1.5em; }
    .markdown-body li { margin: 0.25em 0; }
    .markdown-body code { background: #1e293b; padding: 0.15em 0.4em; border-radius: 3px; font-size: 0.9em; }
    .markdown-body pre { background: #1e293b; padding: 1em; border-radius: 6px; overflow-x: auto; margin: 0.5em 0; }
    .markdown-body pre code { background: none; padding: 0; }
    .markdown-body p { margin: 0.4em 0; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
  </style>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} }
    }
  </script>
</head>
<body class="dark bg-slate-900 text-slate-200 min-h-screen">
<div id="app" v-cloak>
  <!-- Header -->
  <header class="bg-slate-800 border-b border-slate-700 px-6 py-3 flex items-center justify-between sticky top-0 z-40">
    <div class="flex items-center gap-3">
      <span class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
        Claude Autopilot
      </span>
      <span v-if="wsConnected" class="w-2 h-2 rounded-full bg-green-400" title="WebSocket connected"></span>
      <span v-else class="w-2 h-2 rounded-full bg-red-400 pulse" title="WebSocket disconnected"></span>
      <!-- Autopilot Status -->
      <span v-if="autopilotStatus.running"
            class="text-xs px-2 py-0.5 rounded bg-green-500/20 text-green-300 flex items-center gap-1">
        <span class="w-1.5 h-1.5 rounded-full bg-green-400 pulse"></span> Running
      </span>
    </div>

    <div class="flex items-center gap-4">
      <!-- Session Selector -->
      <select v-model="selectedSession" @change="loadTasks"
              class="bg-slate-700 text-slate-200 text-sm rounded px-3 py-1.5 border border-slate-600 focus:border-blue-500 outline-none">
        <option value="">-- Select Session --</option>
        <option v-for="s in sessions" :key="s.id" :value="s.id">
          {{ s.short_id }} ({{ s.completed }}/{{ s.total_tasks }} done)
        </option>
      </select>

      <!-- Tab Navigation -->
      <nav class="flex gap-1">
        <button v-for="tab in tabs" :key="tab.id"
                @click="activeTab = tab.id"
                :class="[
                  'px-3 py-1.5 rounded text-sm font-medium transition-colors',
                  activeTab === tab.id
                    ? 'bg-blue-600 text-white'
                    : 'text-slate-400 hover:text-white hover:bg-slate-700'
                ]">
          {{ tab.label }}
        </button>
      </nav>
    </div>
  </header>

  <main class="p-4">
    <!-- Kanban Board -->
    <div v-if="activeTab === 'kanban'" class="flex gap-4 overflow-x-auto">
      <div v-for="col in columns" :key="col.status"
           class="kanban-col flex-1 min-w-[280px] max-w-[360px]">
        <div :class="['rounded-t-lg px-4 py-2 flex items-center justify-between', col.headerClass]">
          <span class="font-semibold text-sm">{{ col.label }}</span>
          <span class="bg-black/20 text-xs px-2 py-0.5 rounded-full">
            {{ tasksByStatus(col.status).length }}
          </span>
        </div>
        <div class="bg-slate-800/50 rounded-b-lg p-2 space-y-2 min-h-[200px]">
          <div v-for="task in tasksByStatus(col.status)" :key="task.id"
               @click="selectTask(task)"
               :class="[
                 'task-card rounded-lg p-3 cursor-pointer border',
                 selectedTask?.id === task.id
                   ? 'border-blue-500 bg-slate-700'
                   : 'border-slate-700 bg-slate-800 hover:border-slate-500'
               ]">
            <div class="flex items-start justify-between gap-2">
              <span class="text-xs font-mono text-slate-400">#{{ task.id }}</span>
              <span v-if="task.status === 'in_progress'"
                    class="text-xs px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300">
                {{ task.activeForm || 'Working...' }}
              </span>
            </div>
            <p class="text-sm font-medium mt-1 leading-snug">{{ task.subject }}</p>
            <div v-if="task.blockedBy?.length" class="mt-2 flex flex-wrap gap-1">
              <span v-for="dep in task.blockedBy" :key="dep"
                    :class="[
                      'text-xs px-1.5 py-0.5 rounded',
                      isTaskCompleted(dep)
                        ? 'bg-green-500/20 text-green-300 line-through'
                        : 'bg-yellow-500/20 text-yellow-300'
                    ]">
                depends #{{ dep }}
              </span>
            </div>
            <div v-if="task.blocks?.length" class="mt-1 flex flex-wrap gap-1">
              <span v-for="b in task.blocks" :key="b"
                    class="text-xs px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-300">
                blocks #{{ b }}
              </span>
            </div>
          </div>
          <div v-if="tasksByStatus(col.status).length === 0"
               class="text-center text-slate-500 text-sm py-8">
            No tasks
          </div>
        </div>
      </div>
    </div>

    <!-- Progress View -->
    <div v-if="activeTab === 'progress'" class="max-w-4xl mx-auto">
      <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
        <h2 class="text-lg font-bold mb-4">Autopilot Progress</h2>
        <div class="markdown-body text-slate-300" v-html="renderedProgress"></div>
      </div>
    </div>

    <!-- Control Panel (P2) -->
    <div v-if="activeTab === 'control'" class="max-w-5xl mx-auto space-y-6">
      <!-- Autopilot Control -->
      <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
        <h2 class="text-lg font-bold mb-4">Autopilot Control</h2>
        <div class="flex items-center gap-4 mb-4">
          <div class="flex-1">
            <input v-model="autopilotGoal" placeholder="Goal (e.g. 'Build user auth module')"
                   class="w-full bg-slate-700 text-slate-200 text-sm rounded px-3 py-2 border border-slate-600 focus:border-blue-500 outline-none"
                   :disabled="autopilotStatus.running">
          </div>
          <button v-if="!autopilotStatus.running"
                  @click="startAutopilot"
                  class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-sm font-medium transition-colors">
            Start
          </button>
          <button v-else
                  @click="stopAutopilot"
                  class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-sm font-medium transition-colors">
            Stop
          </button>
        </div>
        <div class="grid grid-cols-3 gap-4 text-sm">
          <div class="bg-slate-900 rounded p-3">
            <span class="text-slate-500">Sessions</span>
            <p class="text-xl font-bold">{{ autopilotStatus.session_count || 0 }}</p>
          </div>
          <div class="bg-slate-900 rounded p-3">
            <span class="text-slate-500">Status</span>
            <p class="text-xl font-bold" :class="autopilotStatus.running ? 'text-green-400' : 'text-slate-400'">
              {{ autopilotStatus.running ? 'Running' : (autopilotStatus.status || 'idle') }}
            </p>
          </div>
          <div class="bg-slate-900 rounded p-3">
            <span class="text-slate-500">Started</span>
            <p class="text-sm font-mono">{{ autopilotStatus.started_at ? new Date(autopilotStatus.started_at).toLocaleString() : '-' }}</p>
          </div>
        </div>
      </div>

      <!-- Live Autopilot Output -->
      <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold">Live Output</h2>
          <div class="flex items-center gap-2">
            <label class="flex items-center gap-1 text-xs text-slate-400">
              <input type="checkbox" v-model="autoScroll" class="rounded">
              Auto-scroll
            </label>
            <button @click="autopilotLiveLog = ''; loadAutopilotLogs()"
                    class="px-2 py-1 rounded text-xs bg-slate-700 text-slate-300 hover:bg-slate-600">
              Refresh
            </button>
          </div>
        </div>
        <pre ref="liveLogEl" class="text-xs text-green-300 whitespace-pre-wrap font-mono max-h-[50vh] overflow-auto bg-black rounded p-3">{{ autopilotLiveLog || 'Autopilot output will appear here when running...' }}</pre>
      </div>

      <!-- Session Log Files -->
      <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold">Session Logs</h2>
          <select v-model="selectedLog" @change="loadLog(selectedLog)"
                  class="bg-slate-700 text-slate-200 text-xs rounded px-2 py-1 border border-slate-600">
            <option value="">Select log...</option>
            <option v-for="log in logs" :key="log.name" :value="log.name">{{ log.name }}</option>
          </select>
        </div>
        <pre class="text-xs text-slate-300 whitespace-pre-wrap font-mono max-h-[40vh] overflow-auto bg-slate-900 rounded p-3">{{ logContent || 'No log selected...' }}</pre>
      </div>

      <!-- CLAUDE.md Editor -->
      <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold">CLAUDE.md Editor</h2>
          <div class="flex gap-2">
            <button @click="configEditing = !configEditing"
                    :class="[
                      'px-3 py-1 rounded text-xs font-medium transition-colors',
                      configEditing ? 'bg-yellow-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                    ]">
              {{ configEditing ? 'Preview' : 'Edit' }}
            </button>
            <button v-if="configEditing" @click="saveClaudeMd"
                    class="px-3 py-1 rounded text-xs font-medium bg-blue-600 hover:bg-blue-500 text-white transition-colors">
              Save
            </button>
          </div>
        </div>
        <div v-if="configEditing">
          <textarea v-model="claudeMdDraft"
                    class="w-full h-[50vh] bg-slate-900 text-slate-300 text-sm font-mono rounded p-4 border border-slate-600 focus:border-blue-500 outline-none resize-none"></textarea>
        </div>
        <div v-else class="markdown-body text-slate-300 max-h-[50vh] overflow-auto" v-html="renderedClaudeMd"></div>
      </div>
    </div>

    <!-- Logs View -->
    <div v-if="activeTab === 'logs'" class="max-w-5xl mx-auto">
      <div class="flex gap-4">
        <div class="w-64 shrink-0">
          <h3 class="text-sm font-semibold text-slate-400 mb-2">Log Files</h3>
          <div class="space-y-1">
            <button v-for="log in logs" :key="log.name"
                    @click="loadLog(log.name)"
                    :class="[
                      'w-full text-left px-3 py-2 rounded text-xs font-mono truncate transition-colors',
                      selectedLog === log.name
                        ? 'bg-blue-600 text-white'
                        : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                    ]">
              {{ log.name }}
            </button>
            <p v-if="logs.length === 0" class="text-slate-500 text-sm px-3 py-2">No logs yet</p>
          </div>
        </div>
        <div class="flex-1 bg-slate-800 rounded-lg border border-slate-700 p-4">
          <pre class="text-xs text-slate-300 whitespace-pre-wrap font-mono max-h-[70vh] overflow-auto">{{ logContent || 'Select a log file...' }}</pre>
        </div>
      </div>
    </div>

    <!-- Dependency Graph (P3) -->
    <div v-if="activeTab === 'graph'" class="max-w-6xl mx-auto">
      <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold">Task Dependency Graph</h2>
          <div class="flex items-center gap-4 text-xs">
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-green-600 inline-block"></span> Completed</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-blue-600 inline-block"></span> In Progress</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-slate-600 inline-block"></span> Pending</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-red-600 inline-block"></span> Failed</span>
            <span v-if="criticalPath.length" class="text-yellow-300 font-medium">
              Critical path: {{ criticalPath.map(id => '#' + id).join(' -> ') }}
            </span>
          </div>
        </div>
        <div v-if="tasks.length === 0" class="text-slate-500 text-center py-8">
          Select a session to view dependency graph
        </div>
        <div v-else ref="mermaidContainer" class="flex justify-center overflow-auto"></div>
      </div>
    </div>
  </main>

  <!-- Task Detail Slide-over (P1) -->
  <Transition name="slide">
    <div v-if="selectedTask && activeTab === 'kanban'"
         class="fixed top-0 right-0 h-full w-[520px] bg-slate-800 border-l border-slate-700 z-50 shadow-2xl flex flex-col">
      <!-- Header -->
      <div class="px-4 py-3 border-b border-slate-700 flex items-center justify-between shrink-0">
        <div>
          <span class="text-xs font-mono text-slate-400">#{{ selectedTask.id }}</span>
          <h3 class="text-sm font-bold">{{ selectedTask.subject }}</h3>
        </div>
        <button @click="selectedTask = null"
                class="text-slate-400 hover:text-white text-lg px-2">&times;</button>
      </div>

      <!-- Detail Tabs -->
      <div class="flex border-b border-slate-700 shrink-0">
        <button v-for="dt in detailTabs" :key="dt.id"
                @click="activeDetailTab = dt.id"
                :class="[
                  'px-4 py-2 text-xs font-medium transition-colors border-b-2',
                  activeDetailTab === dt.id
                    ? 'border-blue-500 text-blue-400'
                    : 'border-transparent text-slate-400 hover:text-white'
                ]">
          {{ dt.label }}
        </button>
      </div>

      <!-- Detail Content -->
      <div class="flex-1 overflow-auto p-4">
        <!-- Description Tab -->
        <div v-if="activeDetailTab === 'desc'">
          <div class="text-sm text-slate-300 whitespace-pre-wrap">{{ selectedTask.description || 'No description' }}</div>
          <div class="mt-4 space-y-2">
            <div class="flex items-center gap-2 text-xs">
              <span class="text-slate-500">Status:</span>
              <span :class="statusClass(selectedTask.status)">{{ selectedTask.status }}</span>
            </div>
            <div v-if="selectedTask.activeForm" class="flex items-center gap-2 text-xs">
              <span class="text-slate-500">Active:</span>
              <span class="text-blue-300">{{ selectedTask.activeForm }}</span>
            </div>
          </div>
        </div>

        <!-- Commits Tab -->
        <div v-if="activeDetailTab === 'code'">
          <div v-if="taskCommits.length === 0" class="text-slate-500 text-sm">No commits found for this task</div>
          <div v-for="c in taskCommits" :key="c.hash" class="mb-3">
            <div class="bg-slate-900 rounded p-3 cursor-pointer hover:bg-slate-900/80"
                 @click="loadDiff(c.hash)">
              <div class="flex items-center gap-2">
                <span class="font-mono text-xs text-blue-400">{{ c.hash }}</span>
                <span class="text-xs text-slate-500">{{ c.date }}</span>
              </div>
              <p class="text-sm mt-1">{{ c.message }}</p>
              <p class="text-xs text-slate-500 mt-1">{{ c.author }}</p>
            </div>
            <pre v-if="expandedDiff === c.hash" class="text-xs text-slate-400 bg-slate-950 rounded-b p-3 font-mono overflow-x-auto max-h-64">{{ diffContent }}</pre>
          </div>
        </div>

        <!-- Test Tab -->
        <div v-if="activeDetailTab === 'test'">
          <div class="flex items-center gap-2 mb-4">
            <select v-model="testCommand"
                    class="bg-slate-700 text-slate-200 text-sm rounded px-3 py-1.5 border border-slate-600 outline-none">
              <option value="pytest">pytest</option>
              <option value="python -m pytest">python -m pytest</option>
              <option value="playwright test">playwright test</option>
            </select>
            <button @click="runTest" :disabled="testRunning"
                    :class="[
                      'px-3 py-1.5 rounded text-sm font-medium transition-colors',
                      testRunning
                        ? 'bg-slate-600 text-slate-400 cursor-not-allowed'
                        : 'bg-green-600 hover:bg-green-500 text-white'
                    ]">
              {{ testRunning ? 'Running...' : 'Run Test' }}
            </button>
          </div>
          <pre ref="testOutput" class="text-xs text-slate-300 whitespace-pre-wrap font-mono max-h-[50vh] overflow-auto bg-slate-900 rounded p-3">{{ testOutputText || 'Click "Run Test" to start...' }}</pre>
        </div>

        <!-- Dependencies Tab -->
        <div v-if="activeDetailTab === 'deps'">
          <h4 class="text-xs font-semibold text-slate-400 mb-2">Blocked By</h4>
          <div v-if="!selectedTask.blockedBy?.length" class="text-sm text-slate-500 mb-4">None</div>
          <div v-else class="space-y-1 mb-4">
            <div v-for="dep in selectedTask.blockedBy" :key="dep"
                 @click="jumpToTask(dep)"
                 class="flex items-center gap-2 text-sm cursor-pointer hover:text-white transition-colors">
              <span :class="isTaskCompleted(dep) ? 'text-green-400' : 'text-yellow-400'">
                {{ isTaskCompleted(dep) ? '\u2713' : '\u25cb' }}
              </span>
              <span class="font-mono text-xs">#{{ dep }}</span>
              <span class="text-slate-400">{{ getTaskSubject(dep) }}</span>
            </div>
          </div>
          <h4 class="text-xs font-semibold text-slate-400 mb-2">Blocks</h4>
          <div v-if="!selectedTask.blocks?.length" class="text-sm text-slate-500">None</div>
          <div v-else class="space-y-1">
            <div v-for="b in selectedTask.blocks" :key="b"
                 @click="jumpToTask(b)"
                 class="flex items-center gap-2 text-sm cursor-pointer hover:text-white transition-colors">
              <span class="font-mono text-xs">#{{ b }}</span>
              <span class="text-slate-400">{{ getTaskSubject(b) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </Transition>

  <!-- Backdrop -->
  <Transition name="fade">
    <div v-if="selectedTask && activeTab === 'kanban'"
         @click="selectedTask = null"
         class="fixed inset-0 bg-black/30 z-40"></div>
  </Transition>
</div>

<script>
const { createApp, ref, computed, watch, onMounted, onUnmounted, nextTick } = Vue;

createApp({
  setup() {
    // State
    const sessions = ref([]);
    const selectedSession = ref('');
    const tasks = ref([]);
    const selectedTask = ref(null);
    const progress = ref('');
    const claudeMd = ref('');
    const claudeMdDraft = ref('');
    const configEditing = ref(false);
    const logs = ref([]);
    const selectedLog = ref('');
    const logContent = ref('');
    const taskCommits = ref([]);
    const expandedDiff = ref('');
    const diffContent = ref('');
    const testCommand = ref('pytest');
    const testRunning = ref(false);
    const testOutputText = ref('');
    const testOutput = ref(null);
    const wsConnected = ref(false);
    const activeTab = ref('kanban');
    const activeDetailTab = ref('desc');
    const mermaidContainer = ref(null);
    const autopilotStatus = ref({});
    const autopilotGoal = ref('');
    const autopilotLiveLog = ref('');
    const liveLogEl = ref(null);
    const autoScroll = ref(true);

    const tabs = [
      { id: 'kanban', label: 'Kanban' },
      { id: 'progress', label: 'Progress' },
      { id: 'graph', label: 'Graph' },
      { id: 'control', label: 'Control' },
      { id: 'logs', label: 'Logs' },
    ];

    const detailTabs = [
      { id: 'desc', label: 'Description' },
      { id: 'code', label: 'Commits' },
      { id: 'test', label: 'Test' },
      { id: 'deps', label: 'Dependencies' },
    ];

    const columns = [
      { status: 'pending', label: 'Pending', headerClass: 'bg-slate-600' },
      { status: 'in_progress', label: 'In Progress', headerClass: 'bg-blue-600' },
      { status: 'completed', label: 'Completed', headerClass: 'bg-green-600' },
      { status: 'failed', label: 'Failed', headerClass: 'bg-red-600' },
    ];

    // API helpers
    const api = async (path, opts) => {
      const res = await fetch(path, opts);
      return res.json();
    };

    // Data loading
    const loadSessions = async () => {
      sessions.value = await api('/api/sessions');
      if (!selectedSession.value && sessions.value.length > 0) {
        selectedSession.value = sessions.value[0].id;
        await loadTasks();
      }
    };

    const loadTasks = async () => {
      if (!selectedSession.value) { tasks.value = []; return; }
      tasks.value = await api(`/api/tasks/${selectedSession.value}`);
    };

    const loadProgress = async () => {
      const data = await api('/api/progress');
      progress.value = data.content || '';
    };

    const loadClaudeMd = async () => {
      const data = await api('/api/claude-md');
      claudeMd.value = data.content || '';
      if (!configEditing.value) claudeMdDraft.value = claudeMd.value;
    };

    const saveClaudeMd = async () => {
      await api('/api/claude-md', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: claudeMdDraft.value }),
      });
      claudeMd.value = claudeMdDraft.value;
      configEditing.value = false;
    };

    const loadLogs = async () => {
      logs.value = await api('/api/logs');
    };

    const loadLog = async (name) => {
      if (!name) return;
      selectedLog.value = name;
      const data = await api(`/api/logs/${name}`);
      logContent.value = data.content || '';
    };

    const loadCommits = async (taskId) => {
      taskCommits.value = await api(`/api/commits/${taskId}`);
      expandedDiff.value = '';
    };

    const loadDiff = async (hash) => {
      if (expandedDiff.value === hash) { expandedDiff.value = ''; return; }
      const data = await api(`/api/diff/${hash}`);
      diffContent.value = data.content || '';
      expandedDiff.value = hash;
    };

    const loadAutopilotStatus = async () => {
      autopilotStatus.value = await api('/api/autopilot/status');
    };

    const loadAutopilotLogs = async () => {
      const data = await api('/api/autopilot/logs?tail=500');
      autopilotLiveLog.value = (data.lines || []).join('');
      await nextTick();
      if (autoScroll.value && liveLogEl.value) {
        liveLogEl.value.scrollTop = liveLogEl.value.scrollHeight;
      }
    };

    const startAutopilot = async () => {
      autopilotLiveLog.value = '';
      await api('/api/autopilot/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ goal: autopilotGoal.value }),
      });
      await loadAutopilotStatus();
    };

    const stopAutopilot = async () => {
      await api('/api/autopilot/stop', { method: 'POST' });
      await loadAutopilotStatus();
    };

    // Test runner (SSE)
    const runTest = async () => {
      testRunning.value = true;
      testOutputText.value = '';
      try {
        const res = await fetch('/api/test/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: testCommand.value }),
        });
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                if (data.line) testOutputText.value += data.line;
                if (data.done) {
                  testOutputText.value += `\n--- Exit code: ${data.returncode} ---`;
                }
              } catch {}
            }
          }
          if (testOutput.value) {
            testOutput.value.scrollTop = testOutput.value.scrollHeight;
          }
        }
      } catch (e) {
        testOutputText.value += `\nError: ${e.message}`;
      }
      testRunning.value = false;
    };

    // Computed
    const tasksByStatus = (status) => {
      return tasks.value.filter(t => t.status === status);
    };

    const renderedProgress = computed(() => {
      if (!progress.value) return '<p class="text-slate-500">No progress file found</p>';
      return marked.parse(progress.value);
    });

    const renderedClaudeMd = computed(() => {
      if (!claudeMd.value) return '<p class="text-slate-500">No CLAUDE.md found</p>';
      return marked.parse(claudeMd.value);
    });

    const isTaskCompleted = (id) => {
      const t = tasks.value.find(t => String(t.id) === String(id));
      return t?.status === 'completed';
    };

    const getTaskSubject = (id) => {
      const t = tasks.value.find(t => String(t.id) === String(id));
      return t?.subject || 'Unknown';
    };

    const statusClass = (status) => {
      const map = {
        pending: 'text-slate-400 bg-slate-500/20 px-2 py-0.5 rounded',
        in_progress: 'text-blue-300 bg-blue-500/20 px-2 py-0.5 rounded',
        completed: 'text-green-300 bg-green-500/20 px-2 py-0.5 rounded',
        failed: 'text-red-300 bg-red-500/20 px-2 py-0.5 rounded',
      };
      return map[status] || '';
    };

    // Critical path computation (P3)
    const criticalPath = computed(() => {
      if (tasks.value.length === 0) return [];
      const incomplete = tasks.value.filter(t => t.status !== 'completed');
      if (incomplete.length === 0) return [];
      const taskMap = {};
      tasks.value.forEach(t => { taskMap[t.id] = t; });
      // Find longest path among incomplete tasks
      const memo = {};
      const longestFrom = (id) => {
        if (memo[id] !== undefined) return memo[id];
        const t = taskMap[id];
        if (!t || !t.blocks?.length) { memo[id] = [id]; return [id]; }
        let best = [];
        for (const b of t.blocks) {
          if (taskMap[b] && taskMap[b].status !== 'completed') {
            const path = longestFrom(b);
            if (path.length > best.length) best = path;
          }
        }
        memo[id] = [id, ...best];
        return memo[id];
      };
      let longest = [];
      for (const t of incomplete) {
        const blockedByIncomplete = (t.blockedBy || []).some(dep => taskMap[dep] && taskMap[dep].status !== 'completed');
        if (!blockedByIncomplete) {
          const path = longestFrom(t.id);
          if (path.length > longest.length) longest = path;
        }
      }
      return longest;
    });

    // Task selection
    const selectTask = async (task) => {
      selectedTask.value = task;
      activeDetailTab.value = 'desc';
      await loadCommits(task.id);
    };

    const jumpToTask = (id) => {
      const t = tasks.value.find(t => String(t.id) === String(id));
      if (t) selectTask(t);
    };

    // Mermaid graph
    const renderGraph = async () => {
      if (!mermaidContainer.value || tasks.value.length === 0) return;
      const cp = new Set(criticalPath.value.map(String));
      let graph = 'graph LR\n';
      for (const t of tasks.value) {
        const label = t.subject.replace(/"/g, "'");
        const shape = t.status === 'completed' ? `["\u2713 ${label}"]`
                    : t.status === 'in_progress' ? `(["${label}"])`
                    : `["${label}"]`;
        graph += `  T${t.id}${shape}\n`;
        const statusStyle = t.status === 'completed' ? 'fill:#166534,stroke:#22c55e,color:#fff'
                          : t.status === 'in_progress' ? 'fill:#1e40af,stroke:#3b82f6,color:#fff'
                          : t.status === 'failed' ? 'fill:#991b1b,stroke:#ef4444,color:#fff'
                          : 'fill:#334155,stroke:#64748b,color:#cbd5e1';
        graph += `  style T${t.id} ${statusStyle}\n`;
        if (t.blockedBy) {
          for (const dep of t.blockedBy) {
            const isCritical = cp.has(String(t.id)) && cp.has(String(dep));
            graph += isCritical
              ? `  T${dep} ==>|critical| T${t.id}\n`
              : `  T${dep} --> T${t.id}\n`;
          }
        }
      }
      mermaidContainer.value.innerHTML = '';
      try {
        const { svg } = await mermaid.render('dag-' + Date.now(), graph);
        mermaidContainer.value.innerHTML = svg;
      } catch(e) {
        mermaidContainer.value.innerHTML = '<p class="text-red-400">Failed to render graph</p>';
      }
    };

    // WebSocket
    let ws = null;
    let wsRetryTimer = null;

    const connectWs = () => {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${proto}//${location.host}/ws`);
      ws.onopen = () => { wsConnected.value = true; };
      ws.onclose = () => {
        wsConnected.value = false;
        wsRetryTimer = setTimeout(connectWs, 3000);
      };
      ws.onmessage = async (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'file_change') {
          await loadTasks();
          await loadProgress();
          await loadLogs();
          await loadAutopilotStatus();
          if (activeTab.value === 'graph') await renderGraph();
        }
        if (msg.type === 'autopilot_log') {
          autopilotLiveLog.value += msg.line;
          await nextTick();
          if (autoScroll.value && liveLogEl.value) {
            liveLogEl.value.scrollTop = liveLogEl.value.scrollHeight;
          }
        }
      };
    };

    // Watchers
    watch(activeTab, async (tab) => {
      if (tab === 'progress') await loadProgress();
      if (tab === 'logs') await loadLogs();
      if (tab === 'control') { await loadLogs(); await loadClaudeMd(); await loadAutopilotStatus(); await loadAutopilotLogs(); }
      if (tab === 'graph') { await nextTick(); await renderGraph(); }
    });

    watch(configEditing, (editing) => {
      if (editing) claudeMdDraft.value = claudeMd.value;
    });

    // Init
    onMounted(async () => {
      mermaid.initialize({ startOnLoad: false, theme: 'dark', themeVariables: { darkMode: true } });
      await loadSessions();
      await loadProgress();
      await loadAutopilotStatus();
      connectWs();
    });

    onUnmounted(() => {
      if (ws) ws.close();
      if (wsRetryTimer) clearTimeout(wsRetryTimer);
    });

    return {
      sessions, selectedSession, tasks, selectedTask, progress, claudeMd, claudeMdDraft,
      configEditing, logs, selectedLog, logContent, taskCommits, expandedDiff, diffContent,
      testCommand, testRunning, testOutputText, testOutput, wsConnected,
      activeTab, activeDetailTab, mermaidContainer, autopilotStatus, autopilotGoal,
      autopilotLiveLog, liveLogEl, autoScroll,
      tabs, detailTabs, columns, criticalPath,
      loadTasks, loadLog, loadDiff, saveClaudeMd, startAutopilot, stopAutopilot, runTest,
      loadAutopilotLogs,
      tasksByStatus, renderedProgress, renderedClaudeMd,
      isTaskCompleted, getTaskSubject, statusClass, selectTask, jumpToTask,
    };
  }
}).mount('#app');
</script>
</body>
</html>
